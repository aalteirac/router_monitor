var xml2js = require('xml2js');
var js2xml = new xml2js.Builder();
var crypto = require('crypto');
var request = require('request');

var endpoints = module.exports;

endpoints.sendRequest = function(uri, token, post, callback) {
  var options = {
    url: uri,
    // proxy: 'http://127.0.0.1:8888',
    headers: {
      'Cookie': token.cookies,
      '__RequestVerificationToken': token.token
    }
  };
  if (post) {
    options.method = 'POST';
    if (typeof post === "object") 
      options.form = js2xml.buildObject({request:post});
    else 
      options.body = post;
  }

  request(options, function(error, response, body) {
    if (error || !response ) { 
      callback(error || "Empty response!", null);
      return
    }

    if (response.headers['set-cookie']){
      token.cookies =  response.headers['set-cookie'][0].split(';')[0] +"; "+response.headers['set-cookie'][0].split(';')[0];
    } 
    if (response.headers['__requestverificationtoken']){
      token.token = response.headers['__requestverificationtoken'];
    } 

    xml2js.parseString(body, function(error, response) {
      if (response.error) {
        if (errorCodes[response.error.code]) callback(errorCodes[response.error.code]);
        else callback(new Error(response.error.code + ': ' + response.error.message));
      } else {
        callback(error, response.response);
      }
    });
  });
};

endpoints.hashPassword = function(text) {
  return new Buffer.from(crypto.createHash('sha256')
    .update(text)
    .digest('hex'),
    'utf-8').toString('base64');
};

var errorCodes={
"100004":"ERROR_BUSY",
"101004":"ERROR_CHECK_SIM_CARD_CAN_UNUSEABLE",
"101002":"ERROR_CHECK_SIM_CARD_PIN_LOCK",
"101003":"ERROR_CHECK_SIM_CARD_PUN_LOCK",
"103102":"ERROR_COMPRESS_LOG_FILE_FAILED",
"118005":"ERROR_CRADLE_CODING_FAILED",
"118001":"ERROR_CRADLE_GET_CRURRENT_CONNECTED_USER_IP_FAILED",
"118002":"ERROR_CRADLE_GET_CRURRENT_CONNECTED_USER_MAC_FAILED",
"118004":"ERROR_CRADLE_GET_WAN_INFORMATION_FAILED",
"118003":"ERROR_CRADLE_SET_MAC_FAILED",
"118006":"ERROR_CRADLE_UPDATE_PROFILE_FAILED",
"-1":"ERROR_DEFAULT",
"103001":"ERROR_DEVICE_AT_EXECUTE_FAILED",
"103015":"ERROR_DEVICE_COMPRESS_LOG_FILE_FAILED",
"103006":"ERROR_DEVICE_GET_API_VERSION_FAILED",
"103005":"ERROR_DEVICE_GET_AUTORUN_VERSION_FAILED",
"103014":"ERROR_DEVICE_GET_LOG_INFORMATON_LEVEL_FAILED",
"103012":"ERROR_DEVICE_GET_PC_AISSST_INFORMATION_FAILED",
"103007":"ERROR_DEVICE_GET_PRODUCT_INFORMATON_FAILED",
"103010":"ERROR_DEVICE_NOT_SUPPORT_REMOTE_OPERATE",
"103003":"ERROR_DEVICE_PIN_MODIFFY_FAILED",
"103002":"ERROR_DEVICE_PIN_VALIDATE_FAILED",
"103011":"ERROR_DEVICE_PUK_DEAD_LOCK",
"103004":"ERROR_DEVICE_PUK_MODIFFY_FAILED",
"103016":"ERROR_DEVICE_RESTORE_FILE_DECRYPT_FAILED",
"103018":"ERROR_DEVICE_RESTORE_FILE_FAILED",
"103017":"ERROR_DEVICE_RESTORE_FILE_VERSION_MATCH_FAILED",
"103013":"ERROR_DEVICE_SET_LOG_INFORMATON_LEVEL_FAILED",
"103101":"ERROR_DEVICE_SET_TIME_FAILED",
"103008":"ERROR_DEVICE_SIM_CARD_BUSY",
"103009":"ERROR_DEVICE_SIM_LOCK_INPUT_ERROR",
"104001":"ERROR_DHCP_ERROR",
"107724":"ERROR_DIALUP_ADD_PRORILE_ERROR",
"107722":"ERROR_DIALUP_DIALUP_MANAGMENT_PARSE_ERROR",
"107728":"ERROR_DIALUP_GET_AUTO_APN_MATCH_ERROR",
"107720":"ERROR_DIALUP_GET_CONNECT_FILE_ERROR",
"107727":"ERROR_DIALUP_GET_PRORILE_LIST_ERROR",
"107725":"ERROR_DIALUP_MODIFY_PRORILE_ERROR",
"107729":"ERROR_DIALUP_SET_AUTO_APN_MATCH_ERROR",
"107721":"ERROR_DIALUP_SET_CONNECT_FILE_ERROR",
"107726":"ERROR_DIALUP_SET_DEFAULT_PRORILE_ERROR",
"101008":"ERROR_DISABLE_AUTO_PIN_FAILED",
"101006":"ERROR_DISABLE_PIN_FAILED",
"101009":"ERROR_ENABLE_AUTO_PIN_FAILED",
"101005":"ERROR_ENABLE_PIN_FAILED",
"1":"ERROR_FIRST_SEND",
"100005":"ERROR_FORMAT_ERROR",
"100008":"ERROR_GET_CONFIG_FILE_ERROR",
"102004":"ERROR_GET_CONNECT_STATUS_FAILED",
"102001":"ERROR_GET_NET_TYPE_FAILED",
"102003":"ERROR_GET_ROAM_STATUS_FAILED",
"102002":"ERROR_GET_SERVICE_STATUS_FAILED",
"109001":"ERROR_LANGUAGE_GET_FAILED",
"109002":"ERROR_LANGUAGE_SET_FAILED",
"108003":"ERROR_LOGIN_ALREADY_LOGINED",
"108004":"ERROR_LOGIN_MODIFY_PASSWORD_FAILED",
"108001":"ERROR_LOGIN_NO_EXIST_USER",
"108002":"ERROR_LOGIN_PASSWORD_ERROR",
"108007":"ERROR_LOGIN_TOO_MANY_TIMES",
"108005":"ERROR_LOGIN_TOO_MANY_USERS_LOGINED",
"108006":"ERROR_LOGIN_USERNAME_OR_PASSWORD_ERROR",
"112007":"ERROR_NET_CURRENT_NET_MODE_NOT_SUPPORT",
"112009":"ERROR_NET_MEMORY_ALLOC_FAILED",
"112006":"ERROR_NET_NET_CONNECTED_ORDER_NOT_MATCH",
"112005":"ERROR_NET_REGISTER_NET_FAILED",
"112008":"ERROR_NET_SIM_CARD_NOT_READY_STATUS",
"100002":"ERROR_NOT_SUPPORT",
"-2":"ERROR_NO_DEVICE",
"100003":"ERROR_NO_RIGHT",
"101001":"ERROR_NO_SIM_CARD_OR_INVALID_SIM_CARD",
"110002":"ERROR_ONLINE_UPDATE_ALREADY_BOOTED",
"110007":"ERROR_ONLINE_UPDATE_CANCEL_DOWNLODING",
"110009":"ERROR_ONLINE_UPDATE_CONNECT_ERROR",
"110003":"ERROR_ONLINE_UPDATE_GET_DEVICE_INFORMATION_FAILED",
"110004":"ERROR_ONLINE_UPDATE_GET_LOCAL_GROUP_COMMPONENT_INFORMATION_FAILED",
"110021":"ERROR_ONLINE_UPDATE_INVALID_URL_LIST",
"110024":"ERROR_ONLINE_UPDATE_LOW_BATTERY",
"110006":"ERROR_ONLINE_UPDATE_NEED_RECONNECT_SERVER",
"110023":"ERROR_ONLINE_UPDATE_NOT_BOOT",
"110005":"ERROR_ONLINE_UPDATE_NOT_FIND_FILE_ON_SERVER",
"110022":"ERROR_ONLINE_UPDATE_NOT_SUPPORT_URL_LIST",
"110008":"ERROR_ONLINE_UPDATE_SAME_FILE_LIST",
"110001":"ERROR_ONLINE_UPDATE_SERVER_NOT_ACCESSED",
"100006":"ERROR_PARAMETER_ERROR",
"115003":"ERROR_PB_CALL_SYSTEM_FUCNTION_ERROR",
"115199":"ERROR_PB_LOCAL_TELEPHONE_FULL_ERROR",
"115001":"ERROR_PB_NULL_ARGUMENT_OR_ILLEGAL_ARGUMENT",
"115002":"ERROR_PB_OVERTIME",
"115005":"ERROR_PB_READ_FILE_ERROR",
"115004":"ERROR_PB_WRITE_FILE_ERROR",
"106001":"ERROR_SAFE_ERROR",
"100007":"ERROR_SAVE_CONFIG_FILE_ERROR",
"114002":"ERROR_SD_DIRECTORY_EXIST",
"114001":"ERROR_SD_FILE_EXIST",
"114007":"ERROR_SD_FILE_IS_UPLOADING",
"114005":"ERROR_SD_FILE_NAME_TOO_LONG",
"114004":"ERROR_SD_FILE_OR_DIRECTORY_NOT_EXIST",
"114004":"ERROR_SD_IS_OPERTED_BY_OTHER_USER",
"114006":"ERROR_SD_NO_RIGHT",
"112003":"ERROR_SET_NET_MODE_AND_BAND_FAILED",
"112001":"ERROR_SET_NET_MODE_AND_BAND_WHEN_DAILUP_FAILED",
"112004":"ERROR_SET_NET_SEARCH_MODE_FAILED",
"112002":"ERROR_SET_NET_SEARCH_MODE_WHEN_DAILUP_FAILED",
"113036":"ERROR_SMS_DELETE_SMS_FAILED",
"113053":"ERROR_SMS_LOCAL_SPACE_NOT_ENOUGH",
"113017":"ERROR_SMS_NULL_ARGUMENT_OR_ILLEGAL_ARGUMENT",
"113018":"ERROR_SMS_OVERTIME",
"113020":"ERROR_SMS_QUERY_SMS_INDEX_LIST_ERROR",
"113047":"ERROR_SMS_SAVE_CONFIG_FILE_FAILED",
"113031":"ERROR_SMS_SET_SMS_CENTER_NUMBER_FAILED",
"113054":"ERROR_SMS_TELEPHONE_NUMBER_TOO_LONG",
"116003":"ERROR_STK_CALL_SYSTEM_FUCNTION_ERROR",
"116001":"ERROR_STK_NULL_ARGUMENT_OR_ILLEGAL_ARGUMENT",
"116002":"ERROR_STK_OVERTIME",
"116005":"ERROR_STK_READ_FILE_ERROR",
"116004":"ERROR_STK_WRITE_FILE_ERROR",
"100001":"ERROR_UNKNOWN",
"101007":"ERROR_UNLOCK_PIN_FAILED",
"111018":"ERROR_USSD_AT_SEND_FAILED",
"111017":"ERROR_USSD_CODING_ERROR",
"111016":"ERROR_USSD_EMPTY_COMMAND",
"111001":"ERROR_USSD_ERROR",
"111012":"ERROR_USSD_FUCNTION_RETURN_ERROR",
"111013":"ERROR_USSD_IN_USSD_SESSION",
"111022":"ERROR_USSD_NET_NOT_SUPPORT_USSD",
"111019":"ERROR_USSD_NET_NO_RETURN",
"111020":"ERROR_USSD_NET_OVERTIME",
"111014":"ERROR_USSD_TOO_LONG_CONTENT",
"111021":"ERROR_USSD_XML_SPECIAL_CHARACTER_TRANSFER_FAILED",
"117003":"ERROR_WIFI_PBC_CONNECT_FAILED",
"117001":"ERROR_WIFI_STATION_CONNECT_AP_PASSWORD_ERROR",
"117004":"ERROR_WIFI_STATION_CONNECT_AP_WISPR_PASSWORD_ERROR",
"117002":"ERROR_WIFI_WEB_PASSWORD_OR_DHCP_OVERTIME_ERROR"
}